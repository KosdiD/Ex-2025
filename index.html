<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Smart Home Tour with Raycast Collision</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.5.4/dist/aframe-extras.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.5.4/dist/speech-commands.min.js"></script>
    
    <link rel="stylesheet" href="style.css">

    <script>
        // === –§–Ü–ù–ê–õ–¨–ù–ê –í–ï–†–°–Ü–Ø: –ü—Ä–æ—Å—Ç–∞ —ñ –Ω–∞–¥—ñ–π–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∫–æ–ª—ñ–∑—ñ–π –Ω–∞ –æ—Å–Ω–æ–≤—ñ Raycast ===
        AFRAME.registerComponent('raycast-collider', {
            schema: {
                target: {type: 'string', default: '.collidable'},
                distance: {type: 'number', default: 0.5}, // –ó–º–µ–Ω—à–µ–Ω–æ –≤—ñ–¥—Å—Ç–∞–Ω—å –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç—ñ
                debug: {type: 'boolean', default: true}
            },

            init: function () {
                // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∑–º—ñ–Ω–Ω—ñ –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó
                this.raycaster = new THREE.Raycaster();
                this.worldPosition = new THREE.Vector3();
                this.movementDirection = new THREE.Vector3();
                this.lastGoodPosition = new THREE.Vector3();
                
                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤—É –ª–æ–∫–∞–ª—å–Ω—É –ø–æ–∑–∏—Ü—ñ—é
                this.el.object3D.position.copy(this.lastGoodPosition); 
                console.log("Raycast Collider —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ.");

                // –°—Ç–≤–æ—Ä—é—î–º–æ –ª—ñ–Ω—ñ—é –¥–ª—è –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è, —â–æ–± –±–∞—á–∏—Ç–∏ –ø—Ä–æ–º—ñ–Ω—å
                if (this.data.debug) {
                    this.debugLine = document.createElement('a-entity');
                    this.debugLine.setAttribute('line', {
                        start: '0 0 0',
                        end: '0 0 -2', // –ü–æ—á–∞—Ç–∫–æ–≤–∞ –¥–æ–≤–∂–∏–Ω–∞
                        color: 'red',
                        opacity: 0.5
                    });
                    this.el.appendChild(this.debugLine); // –î–æ–¥–∞—î–º–æ –ª—ñ–Ω—ñ—é —è–∫ –¥–æ—á—ñ—Ä–Ω—ñ–π –µ–ª–µ–º–µ–Ω—Ç –≥—Ä–∞–≤—Ü—è
                }
            },

            tick: function () {
                const el = this.el;
                
                // --- 1. –û—Ç—Ä–∏–º—É—î–º–æ –Ω–∞–ø—Ä—è–º–æ–∫ —Ä—É—Ö—É ---
                const velocity = el.getAttribute('movement-controls')?.velocity;
                if (!velocity || velocity.lengthSq() === 0) {
                    // –Ø–∫—â–æ –Ω–µ —Ä—É—Ö–∞—î–º–æ—Å—å, –æ–Ω–æ–≤–ª—é—î–º–æ –æ—Å—Ç–∞–Ω–Ω—é –±–µ–∑–ø–µ—á–Ω—É –ø–æ–∑–∏—Ü—ñ—é
                    this.lastGoodPosition.copy(el.object3D.position);
                    if(this.debugLine) this.debugLine.setAttribute('visible', false); // –•–æ–≤–∞—î–º–æ –ø—Ä–æ–º—ñ–Ω—å
                    return;
                }
                if(this.debugLine) this.debugLine.setAttribute('visible', true); // –ü–æ–∫–∞–∑—É—î–º–æ –ø—Ä–æ–º—ñ–Ω—å

                // --- 2. –ì–æ—Ç—É—î–º–æ –ø—Ä–æ–º—ñ–Ω—å (Raycaster) ---
                // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω—É —Å–≤—ñ—Ç–æ–≤—É –ø–æ–∑–∏—Ü—ñ—é –≥—Ä–∞–≤—Ü—è
                el.object3D.getWorldPosition(this.worldPosition);
                // –û—Ç—Ä–∏–º—É—î–º–æ –Ω–∞–ø—Ä—è–º–æ–∫ —Ä—É—Ö—É —É —Å–≤—ñ—Ç–æ–≤–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
                this.movementDirection.copy(velocity).applyQuaternion(el.object3D.quaternion).normalize();
                
                // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–æ–º—ñ–Ω—å: –∑–≤—ñ–¥–∫–∏ —ñ –∫—É–¥–∏
                this.raycaster.set(this.worldPosition, this.movementDirection);

                // --- 3. –ó–Ω–∞—Ö–æ–¥–∏–º–æ –æ–±'—î–∫—Ç–∏ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ ---
                const collidableEls = el.sceneEl.querySelectorAll(this.data.target);
                const objectsToTest = Array.from(collidableEls).map(e => e.object3D);

                // --- 4. –ü—É—Å–∫–∞—î–º–æ –ø—Ä–æ–º—ñ–Ω—å —ñ –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∑—ñ—Ç–∫–Ω–µ–Ω–Ω—è ---
                const intersections = this.raycaster.intersectObjects(objectsToTest, true);
                const collisionDetected = intersections.length > 0 && intersections[0].distance < this.data.distance;

                // --- 5. –†–µ–∞–≥—É—î–º–æ –Ω–∞ –∑—ñ—Ç–∫–Ω–µ–Ω–Ω—è ---
                if (collisionDetected) {
                    // –ö–û–õ–Ü–ó–Ü–Ø! –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –≥—Ä–∞–≤—Ü—è –Ω–∞ –æ—Å—Ç–∞–Ω–Ω—é –±–µ–∑–ø–µ—á–Ω—É –ø–æ–∑–∏—Ü—ñ—é
                    el.object3D.position.copy(this.lastGoodPosition);
                } else {
                    // –ù–µ–º–∞—î –∫–æ–ª—ñ–∑—ñ—ó, –æ–Ω–æ–≤–ª—é—î–º–æ –±–µ–∑–ø–µ—á–Ω—É –ø–æ–∑–∏—Ü—ñ—é
                    this.lastGoodPosition.copy(el.object3D.position);
                }

                // –û–Ω–æ–≤–ª—é—î–º–æ –ª—ñ–Ω—ñ—é –¥–ª—è –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è
                if (this.data.debug && this.debugLine) {
                    this.debugLine.setAttribute('line', 'color', collisionDetected ? 'blue' : 'red');
                }
            }
        });
    </script>
</head>
<body>
    <div id="controls-panel">
        <div class="control-group">
            <strong>üéÆ –í–∏—Å–æ—Ç–∞ –≥—Ä–∞–≤—Ü—è:</strong><br>
            <button onclick="changeHeight(-1)">‚Üì</button>
            <input type="number" id="height-input" value="1.6" step="0.1" min="0" max="50">
            <button onclick="changeHeight(1)">‚Üë</button>
            <button onclick="setHeight()">–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏</button><br>
            <small>–ü–æ—Ç–æ—á–Ω–∞ –≤–∏—Å–æ—Ç–∞: <span id="current-height">1.6</span>–º</small>
        </div>
        <div class="control-group">
            <strong>üí° –ö–µ—Ä—É–≤–∞–Ω–Ω—è —Å–≤—ñ—Ç–ª–æ–º:</strong><br>
            <button onclick="createLight()">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —Å–≤—ñ—Ç–ª–æ</button>
            <button onclick="toggleAllLights()">üí° –£–≤—ñ–º–∫/–í–∏–º–∫ –≤—Å—ñ</button>
            <div class="brightness-control">
                <label>–Ø—Å–∫—Ä–∞–≤—ñ—Å—Ç—å:</label>
                <input type="range" id="brightness-slider" min="0" max="100" value="50" onchange="updateBrightness(this.value)">
                <span id="brightness-value">50%</span>
            </div>
        </div>
        <div class="control-group" style="display: none;">
            <strong>üß± –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å—Ç—ñ–Ω:</strong><br>
            <button id="start-wall-btn" onclick="startWallCreation()">–ü–æ—á–∞—Ç–∏ —Å—Ç—ñ–Ω—É</button>
            <button id="create-wall-btn" onclick="createWall()" disabled>–ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Å—Ç—ñ–Ω—É</button>
            <button id="cancel-wall-btn" onclick="cancelWallCreation()" disabled>–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            <small id="wall-status">–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –ø–æ—á–∞—Ç–∫–æ–≤—É —Ç–æ—á–∫—É.</small>
        </div>
        <div class="control-group">
            <strong>üìç –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–∞—Ä–∫–µ—Ä—ñ–≤:</strong><br>
            <button onclick="createMarkerAtCurrentPosition()">–°—Ç–≤–æ—Ä–∏—Ç–∏ –º–∞—Ä–∫–µ—Ä —Ç—É—Ç</button>
            <div id="marker-form" style="display: none;">
                <select id="ml-device-type" style="width: 100%; margin: 5px 0; padding: 5px;">
                    <option value="">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π IoT</option>
                    <option value="vision">üëÅÔ∏è Computer Vision</option>
                    <option value="audio">üîä –ê—É–¥—ñ–æ ML</option>
                    <option value="sensor">üìä –°–µ–Ω—Å–æ—Ä–Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞</option>
                    <option value="motion">üèÉ –î–µ—Ç–µ–∫—Ç–æ—Ä —Ä—É—Ö—É</option>
                    <option value="climate">üå°Ô∏è –ö–ª—ñ–º–∞—Ç ML</option>
                    <option value="light">üí° –†–æ–∑—É–º–Ω–µ —Å–≤—ñ—Ç–ª–æ</option>
                </select>
                <input type="text" id="marker-name" placeholder="–ù–∞–∑–≤–∞ –ø—Ä–∏—Å—Ç—Ä–æ—é">
                <textarea id="marker-description" placeholder="–û–ø–∏—Å –ø—Ä–∏—Å—Ç—Ä–æ—é" rows="3"></textarea>
                <button onclick="saveMarker()">‚úÖ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button onclick="cancelMarker()">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
        <div class="control-group">
            <strong>üè† –®–≤–∏–¥–∫—ñ –¥—ñ—ó:</strong><br>
            <button onclick="resetPosition()">‚Ü©Ô∏è –ù–∞ –ø–æ—á–∞—Ç–æ–∫</button>
            <button onclick="toggleMarkers()">üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç–∏/–°—Ö–æ–≤–∞—Ç–∏</button>
        </div>
        <div class="control-group">
            <strong>üíæ –ï–∫—Å–ø–æ—Ä—Ç/–Ü–º–ø–æ—Ä—Ç:</strong><br>
            <button onclick="exportData()">üì• –ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –≤—Å–µ</button>
            <button onclick="document.getElementById('import-file').click()">üì§ –Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –≤—Å–µ</button>
            <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
        </div>
    </div>
    <div id="position-info">
        <strong>–ü–æ–∑–∏—Ü—ñ—è:</strong><br>
        X: <span id="pos-x">0</span><br>
        Y: <span id="pos-y">10</span><br>
        Z: <span id="pos-z">20</span>
    </div>
    <div id="iot-info-panel">
        <h3 id="iot-title">IoT –ü—Ä–∏—Å—Ç—Ä—ñ–π</h3>
        <p><span class="info-label">–¢–∏–ø:</span> <span id="iot-type">-</span></p>
        <p><span class="info-label">–û–ø–∏—Å:</span> <span id="iot-description">-</span></p>
        <p><span class="info-label">ML –ú–æ–¥–µ–ª—ñ:</span> <span id="iot-ml-models">-</span></p>
        <p><span class="info-label">ML –§—É–Ω–∫—Ü—ñ—ó:</span> <span id="iot-ml-features">-</span></p>
        <p><span class="info-label">–°—Ç–∞—Ç—É—Å:</span> <span id="iot-status">–ê–∫—Ç–∏–≤–Ω–∏–π</span></p>
        <p><span class="info-label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏:</span> <span id="iot-coords">-</span></p>
        <div id="light-controls" style="display: none;">
            <p><span class="info-label">–°—Ç–∞–Ω —Å–≤—ñ—Ç–ª–∞:</span> <span id="light-state">–í–∏–º–∫–Ω–µ–Ω–æ</span></p>
            <p><span class="info-label">–Ø—Å–∫—Ä–∞–≤—ñ—Å—Ç—å:</span> <span id="light-brightness">50%</span></p>
            <button onclick="toggleLightDevice()">üí° –£–≤—ñ–º–∫/–í–∏–º–∫</button>
        </div>
        <button onclick="closeIotPanel()">–ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>
    <div id="voice-control">
        <h3>üé§ –ì–æ–ª–æ—Å–æ–≤–µ –∫–µ—Ä—É–≤–∞–Ω–Ω—è</h3>
        <button id="voice-btn" onclick="toggleVoiceRecognition()">
            <span id="voice-btn-text">–ü–æ—á–∞—Ç–∏ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è</span>
        </button>
        <button onclick="toggleMLMode()">
            <span id="ml-mode-text">ML: –í–∏–º–∫</span>
        </button>
        <div id="voice-status">
            <span class="voice-indicator" id="voice-indicator"></span>
            <span id="voice-status-text">–ì–æ—Ç–æ–≤–æ –¥–æ —Ä–æ–±–æ—Ç–∏</span>
            <div id="voice-transcript"></div>
        </div>
        <small>–ö–æ–º–∞–Ω–¥–∏: "—Å—Ç–≤–æ—Ä–∏—Ç–∏ –º–∞—Ä–∫–µ—Ä", "–ø–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ –º–∞—Ä–∫–µ—Ä–∏", "–Ω–∞ –ø–æ—á–∞—Ç–æ–∫", "–µ–∫—Å–ø–æ—Ä—Ç", "—Å—Ç–≤–æ—Ä–∏—Ç–∏ —Å–≤—ñ—Ç–ª–æ", "—É–≤—ñ–º–∫–Ω—É—Ç–∏/–≤–∏–º–∫–Ω—É—Ç–∏ —Å–≤—ñ—Ç–ª–æ", "—è—Å–∫—Ä–∞–≤—ñ—Å—Ç—å [—á–∏—Å–ª–æ]", "–∑—Ä–æ–±–∏ —Å–≤—ñ—Ç–ª–æ [–∫–æ–ª—ñ—Ä]"</small>
    </div>

    <a-scene background="color: #87CEEB" fog="type: linear; color: #87CEEB; near: 10; far: 100">
        <a-assets>
            <a-asset-item id="house-model" src="box.glb"></a-asset-item>
            <a-asset-item id="collision-walls-asset" src="outbound.glb"></a-asset-item>
        </a-assets>

        <a-light type="ambient" intensity="0.6" id="ambient-light"></a-light>
        <a-light type="directional" position="20 40 20" intensity="0.8" castShadow="true"></a-light>
        
        <a-plane position="0 0 0" rotation="-90 0 0" width="200" height="200"
                 color="#4a5d4a" shadow="receive: true"></a-plane>

        <a-gltf-model src="#house-model" shadow="cast: true; receive: true" id="house"></a-gltf-model>
        
        <a-entity
          gltf-model="#collision-walls-asset"
          visible="false"
          class="collidable">
        </a-entity>
        
        <a-entity id="rig" position="0 0.5 10"
                  movement-controls="speed: 0.15;"
                  raycast-collider="debug: true;">
            <a-entity id="camera"
                      camera
                      position="0 1.6 0"
                      look-controls="pointerLockEnabled: true">
                <a-cursor></a-cursor>
            </a-entity>
        </a-entity>

        <a-entity id="marker-0-0-0" position="0 0 0">
            <a-sphere class="iot-marker" radius="0.5" color="#00bcd4" opacity="0.7"
                      event-set__enter="_event: mouseenter; scale: 1.2 1.2 1.2; opacity: 0.9"
                      event-set__leave="_event: mouseleave; scale: 1 1 1; opacity: 0.7"
                      animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
            </a-sphere>
            <a-text value="–†–æ–∑—É–º–Ω–∏–π —Ö–∞–±" position="-34.7 6.6 -16.90" width="4" align="center" color="#fff"
                    font="../fonts/calibri-msdf.json" visible="false">
            </a-text>
        </a-entity>
    </a-scene>

    <script src="script.js"></script>
</body>
</html>
